<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Nexus æé€Ÿè·³è½¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: system-ui, -apple-system, sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <div id="loader" class="text-center">
        <div class="inline-block w-8 h-8 border-4 border-sky-500 border-t-transparent rounded-full spin mb-4"></div>
        <p class="text-slate-400">æ­£åœ¨è·å–æœ€æ–°é…ç½®...</p>
    </div>

    <div id="app" class="max-w-md w-full hidden">
        <h2 class="text-3xl font-bold text-white text-center mb-8">Hello, <span id="userName" class="text-sky-400">User</span></h2>
        <div id="groupsContainer"></div>
    </div>

    <script>
        (async function() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const loader = document.getElementById('loader');
            const app = document.getElementById('app');

            // è‡ªåŠ¨æ³¨å…¥å˜é‡ (ç”± .yml è‡ªåŠ¨å¡«å……)
            const owner = "__REPO_OWNER__";
            const repo = "__REPO_NAME__";
            const path = "config.json";

            if (!id) {
                window.location.replace("./index.html");
                return;
            }

            // å°è¯•è¯»å– manage.html å­˜ä¸‹çš„ Token
            const token = localStorage.getItem('gh_pat');

            async function fetchConfig() {
                try {
                    // 1. å°è¯•ç›´æ¥è¯·æ±‚ GitHub API è·å–å®æ—¶æ•°æ® (è·³è¿‡éƒ¨ç½²ç­‰å¾…)
                    const apiUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}?v=${Date.now()}`;
                    const headers = token ? { 'Authorization': `token ${token}` } : {};
                    
                    const res = await fetch(apiUrl, { headers });
                    if (!res.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                    
                    const data = await res.json();
                    // è§£ç  Base64 å†…å®¹
                    return JSON.parse(decodeURIComponent(escape(atob(data.content))));
                } catch (e) {
                    console.warn("API å®æ—¶è¯»å–å¤±è´¥ï¼Œæ­£åœ¨å°è¯•è¯»å–æœ¬åœ°ç¼“å­˜æ–‡ä»¶...", e);
                    // 2. é™çº§æ–¹æ¡ˆï¼šè¯»å–å½“å‰æœåŠ¡å™¨ä¸Šçš„é™æ€æ–‡ä»¶ (å¯èƒ½å­˜åœ¨ 30s å»¶è¿Ÿ)
                    const fallback = await fetch(`./config.json?v=${Date.now()}`);
                    return await fallback.json();
                }
            }

            try {
                const config = await fetchConfig();
                const userData = config[id];

                if (!userData) {
                    loader.innerHTML = `<p class="text-rose-500 font-bold">æœªæ‰¾åˆ° ID: ${id}</p>`;
                    return;
                }

                // æå–æœ‰æ•ˆé“¾æ¥
                let allLinks = [];
                for (let groupName in userData) {
                    const groupItems = userData[groupName];
                    for (let linkName in groupItems) {
                        const url = groupItems[linkName];
                        if (url && (url.startsWith('http'))) {
                            allLinks.push({ group: groupName, name: linkName, url: url });
                        }
                    }
                }

                if (allLinks.length === 1) {
                    // ğŸš€ å•é“¾æ¥ï¼šç§’è·³
                    window.location.replace(allLinks[0].url);
                } else if (allLinks.length > 1) {
                    // ğŸ“‹ å¤šé“¾æ¥ï¼šæ¸²æŸ“ UI
                    renderUI(id, userData);
                } else {
                    loader.innerHTML = `<p class="text-slate-500">é…ç½®å†…å®¹ä¸ºç©º</p>`;
                }

            } catch (err) {
                loader.innerHTML = `<p class="text-rose-400">ç³»ç»Ÿé”™è¯¯: ${err.message}</p>`;
            }

            function renderUI(userId, groups) {
                document.getElementById('userName').innerText = userId;
                const container = document.getElementById('groupsContainer');
                let html = '';
                for (const [groupName, links] of Object.entries(groups)) {
                    const validLinks = Object.entries(links).filter(([_, url]) => url && url.startsWith('http'));
                    if (validLinks.length === 0) continue;
                    let linksHtml = validLinks.map(([name, url]) => `
                        <a href="${url}" class="flex justify-between px-5 py-4 border border-slate-700 rounded-xl bg-slate-800 hover:border-sky-500 text-slate-200 transition-all mb-3 group">
                            <span>${name}</span>
                            <span class="text-slate-500 group-hover:text-sky-400">â†’</span>
                        </a>
                    `).join('');
                    html += `<div class="mb-6"><h3 class="text-xs font-bold text-slate-500 uppercase mb-3 tracking-widest">${groupName}</h3><div class="flex flex-col">${linksHtml}</div></div>`;
                }
                container.innerHTML = html;
                loader.classList.add('hidden');
                app.classList.remove('hidden');
            }
        })();
    </script>
</body>
</html>
